import os
from google import genai
from dotenv import load_dotenv

load_dotenv()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ —Å –∫–ª—é—á–æ–º –∏–∑ .env
# –ù–æ–≤—ã–π SDK —Å–∞–º –∏—â–µ—Ç GEMINI_API_KEY, –Ω–æ —è–≤–Ω–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞–¥–µ–∂–Ω–æ
client = genai.Client(api_key=os.getenv("GEMINI_API_KEY"))


async def summarize_reviews(reviews_list):
    if not reviews_list:
        return "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –æ—Ç–∑—ã–≤—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞."

    # –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç
    text_data = "\n\n".join(reviews_list)

    prompt = (
        f"–¢—ã —Å—Ç—Ä–æ–≥–∏–π –∞–Ω–∞–ª–∏—Ç–∏–∫ —Ç–æ–≤–∞—Ä–æ–≤. –°–¥–µ–ª–∞–π –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫—Ä–∞—Ç–∫—É—é –∏ –∂–µ—Å—Ç–∫—É—é –≤—ã–∂–∏–º–∫—É –∏–∑ –æ—Ç–∑—ã–≤–æ–≤ —Å Ozon.\n"
        f"–í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤: {len(reviews_list)}.\n\n"
        f"–ü–†–ê–í–ò–õ–ê:\n"
        f"- –ù–ò–ö–ê–ö–ò–• –≤–≤–æ–¥–Ω—ã—Ö –∏ –∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã—Ö —Ñ—Ä–∞–∑ (–Ω–µ –ø–∏—à–∏ ¬´–ù–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–∑—ã–≤–æ–≤...¬ª).\n"
        f"- –ù–ò–ö–ê–ö–û–ô –≤–æ–¥—ã (–Ω–µ –ø–∏—à–∏ ¬´–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ç–º–µ—á–∞—é—Ç¬ª, ¬´–º–Ω–æ–≥–∏–º –Ω—Ä–∞–≤–∏—Ç—Å—è¬ª). –°—Ä–∞–∑—É –ø–∏—à–∏ —Ñ–∞–∫—Ç.\n"
        f"- –§–æ—Ä–º–∞—Ç: —Ç–æ–ª—å–∫–æ –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–µ–∑–∏—Å—ã (–º–∞–∫—Å–∏–º—É–º 1 —Å—Ç—Ä–æ–∫–∞ –Ω–∞ –ø—É–Ω–∫—Ç).\n"
        f"- –í—ã–¥–µ–ª—è–π –≥–ª–∞–≤–Ω–æ–µ –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º.\n\n"
        f"–°–¢–†–£–ö–¢–£–†–ê:\n"
        f"‚úÖ –ü–ª—é—Å—ã (–≥–ª–∞–≤–Ω—ã–µ —Ñ–∞–∫—Ç—ã)\n"
        f"‚ùå –ú–∏–Ω—É—Å—ã (—á–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã)\n"
        f"‚ö†Ô∏è –ù—é–∞–Ω—Å—ã (–±—Ä–∞–∫, –¥–æ—Å—Ç–∞–≤–∫–∞, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ - –∫–æ—Ä–æ—Ç–∫–æ)\n"
        f"üèÅ –í–µ—Ä–¥–∏–∫—Ç (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è: –∫–æ–º—É –ø–æ–¥–æ–π–¥–µ—Ç, –∞ –∫–æ–º—É –Ω–µ—Ç)\n\n"
        f"–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–æ–≤:\n{text_data[:30000]}"
    )

    try:
        # –û–ë–ù–û–í–õ–ï–ù–û –ü–û–î –ù–û–í–´–ô SDK
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º .aio –¥–ª—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏ (Page 9 PDF)
        response = await client.aio.models.generate_content(
            model="gemini-2.5-flash",  # –ò–ª–∏ 'gemini-2.0-flash', –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞
            contents=prompt,
        )
        return response.text
    except Exception as e:
        return f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ Gemini (New SDK): {e}"
